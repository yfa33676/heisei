前回はプロバイダとパソコン通信の歴史を少しだけ書きました。続いて書きたいのが、IPアドレスの管理体制についてです。

私たちがインターネットに接続できるのは、プロバイダからIPアドレスを割り当てられるからです。しかし、割り当てられるといっても、割り当てられるのは動的IPアドレスであって固定IPアドレスではありません。つまり、インターネットに接続するたびに、プロバイダが管理しているいくつかのIPアドレスの中からあるIPアドレスを選び取られるわけです。動的IPアドレスを割り当てられているということは、クライアントにはなれてもサーバーにはなれない、ということです。つまり、あるホストにリクエストを送りそのホストからレスポンスを受けることはできても、あるホストからリクエストを受けてレスポンスを返すことはできません。

また、プロバイダに割り当てられるのはたかだかひとつの動的IPアドレスです。そのため、割り当てられるホストの数もひとつになります。もし、ひとつのIPアドレスで複数のホストにIPアドレスを割り当てたいときは、ルーターにネットワークアドレス変換をさせることになります。つまり、割り当てられたひとつのグローバルアドレスを複数のプライベートアドレスに変換して割り当てるわけです。プライベートアドレスもまた、リクエストを送りレスポンスを受けることはできても、リクエストを受けてレスポンスを返すことはできません。

それでは、どうしてプロバイダは利用者に複数の固定IPアドレスではなくひとつの動的IPアドレスを割り当てるのか。今回はそのあたりをIPアドレスの管理体制の歴史から考えようと思っています。

＊

ヴィント・サーフというひとがいます。しばしば、インターネットの父と呼ばれるひとで、TCP/IPの設計をしたひとりです。ヴィント・サーフは2012年に慶應義塾大学で行われた講演「インターネットの再発明」でIPアドレスの設計のいきさつを次のように言っていました。

「ボブ・カーンと私が1973年に元々のアドレス空間を設計したときにも、インターネットのアドレス空間がどれだけ必要か考えました。〔…〕1ヶ国あたり平均2つのネットワーク、全部で256のネットワークを識別できるように、8ビットあれば十分だという結論に達しました。こうしてIPv4の構造が決まりました。残りの24ビットは端末として接続されるコンピュータのアドレスに割り当てました。〔…〕1973年当時は、コンピュータがポケットに収まるようになるとは誰も想像しなかったのです。だから、コンピュータはひとつの国に1600万台もあれば十分以上だと思ったのです。実際にはアドレスを使い切った地域も出てきてしまい、アジア太平洋地域では2011年4月でアドレス空間が足りなくなりました」（村井純『インターネットの基礎』）

IPアドレスは32ビットの長さからなります。ヴィント・サーフについてIPアドレスについて、ネットワークを表すのに8ビット、それぞれのホストに割り当てるのに24ビット、合わせて32ビットあれば十分だと考えたわけですが、いまのインターネットの広がりから考えると、あまりにも不十分な量でした。そのため、IPアドレスは管理なく自由に割り当てるのではなく、管理のもとで節約して割り当てなければならなくなったわけです。

＊

日本のIPアドレスを管理しているのはJPNIC（日本ネットワークインフォメーションセンター）です。JPNICが「日本におけるインターネット資源管理の歴史」（https://www.nic.ad.jp/timeline/20th/）として書いたものがありますので、続いて、これを読みます。

「1980年代のインターネットは、米国を中心とした研究ネットワークで、現在のインターネットの規模に比べるとはるかに小さく、スーパーコンピュータの共同利用と、研究者間の情報共有や情報交換のために利用されるのみでした。当初、インターネットプロトコル（IP）に関するプロトコルパラメータの管理は、南カリフォルニア大学のJon Postel氏が個人的に管理していました。 徐々にインターネットの利用者が増えていくに従ってPostel氏が同僚とともに管理を担うようになっていき、IANAと呼ばれるようになりますが、この当時は、「プロトコルパラメータが必要になった場合にはPostel氏に連絡すること」などという、簡単なルールがあるのみでした」

JPNICによれば、IPアドレスの管理はジョン・ポステルが個人で行っていました。インターネットは研究者の間でのみ利用されていたため、そのような管理で十分だったわけですね。しかし、1990年代に入るとそうも言ってられなくなります。

「1990年ごろ米国で商用のインターネットプロバイダが出現し、一般利用者でも料金を支払うことでインターネットを利用できるようになりました。 これによって、インターネットはスーパーコンピュータの共同利用のためだけではなく、広く一般の人々が使うものとなり、ネットワーク規模、利用者とともに、インターネットの爆発的な拡大が始まります。この商用プロバイダ出現からすぐに、世界中の関係者の中で、次の二つの懸念が持たれるようになりました。IPv4アドレスの有限性――近い将来に在庫枯渇が起こるのではないか。経路制御機構の限界――経路の総数がインターネット全体で扱える数を超えることで、経路制御機構が破綻するのではないか」

1990年代に入るとプロバイダなるものが現れます。商用インターネットが始まるわけですね。割り当てるべきIPアドレスが次々と選び取られるようになります。しかし、IPアドレスの体系はそのような広がりに耐えられるようには作られていません。まず、割り当てられるIPアドレスの量に限りがあります。また、経路制御、つまり、あるホストからパケットを受け取り、送るべきホストにパケットを送る、という制御もまた多くのIPアドレスに耐えられるようには作られていませんでした。この危機に応えるために、TCP/IPの改変と新しいTCP/IPの開発が同じくして進められました。この新しいTCP/IPはいまではIPv6と呼ばれています。

「IPv4アドレスの有限性に対するアプローチは、抜本的な対策として、IPv4アドレス空間の在庫枯渇を見越した次世代IP（インターネットプロトコル）の開発でした。〔…〕さらにプロトコル候補が提案されるとともに、複数の候補が統合されるなど、活発に議論された結果、1994年にSIPP（Simple IP Plus）と呼ばれていたプロトコルが、次世代IPに採用されました。 その後、細部の詰めが行われ、このSIPPをベースとした、IPバージョン6（IPv6）の基本仕様が、RFC1883として公開されたのは、1995年12月のことでした」

TCP/IPの改変については、たとえば、CIDR（Classless Inter-Domain Routing）という技術があります。

「CIDRでは、ISPでの集成を可能にするために、連続したIPアドレスをISP〔インターネット・サービス・プロバイダ〕に分配することが必要です。JPNICではこれにいち早く対応し、RFC1518が発行されて間もなく、1993年11月に配下の接続組織に再分配（割り当て）するため、JPNIC会員に連続するIPアドレスを分配（割り振り）するようにしました。実際に、日本のISPでCIDRを活用した経路情報の集成が始まったのは、1995年9月のことです。〔…〕CIDRによって、インターネットには新たに階層的経路制御という概念が持ち込まれました。CIDR以前のインターネットは、IPアドレスは他のネットワークとの接続構成とは無関係に割り当てられ、ネットワーク同士は自由に接続相手を選択することができました。しかしCIDR以後は、IPアドレスは、接続性を提供するISPのブロックから割り当てられることが基本で、ISPを変える場合にはIPアドレスを変える必要があります。この構造化によって、インターネットは若干の自由度を失うことと引き換えに、スケーラビリティを手に入れたことになります」

CIDRについて詳しく書くことは難しいですが、IPアドレスを利用者ごとに割り当てるのではなく、IPアドレスの連続したある範囲をプロバイダに割り振るようになった、ということです。そして、利用者はプロバイダからIPアドレスを割り当てられるわけです。この技術により、それぞれのホストはIPアドレスごとに経路制御を考える必要はなくなり、送るべきIPアドレスがどのプロバイダに割り振られているかを調べて、プロバイダごとに経路制御を考えれば十分になりました。こうして、プロバイダは割り振られたある範囲のIPアドレスを管理することになります。JPNICはこの管理を担当する事業者をIPアドレス管理指定事業者と呼びます。このような改変により、プロバイダはIPアドレスの管理体制において欠かすことができないものになりました。

IPv6の基本仕様が公開されたのは1995年12月です。すでに20年以上が経過していますが、私たちはいまでもIPv4を利用しています。それでは、なぜ移行が遅れているのか。その理由のひとつに、TCP/IPの改変が生き延びている、ということがあります。

「技術的には、第5章で述べたクラスレス技術や、閉域網にプライベートアドレスを用い、インターネットへの接続の際にはグローバルアドレスに変換して通信を行うNAT（Network Address Translation）技術などは、インターネットの拡大に伴うアドレス不足への対応策として、非常に効果的だったと言えます。インターネットの拡大は、IPv6の必要性を高める一方で、IPv6移行へのハードルを高めるという皮肉な結果になったとも言えます」

CIDRの技術、そして、ネットワークアドレス変換（Network Address Translation）の技術はTCP/IPを生き延びさせるための技術でしたが、あるべきインターネットではありません。あるべきインターネットを捨てることで危機を乗り切ったのであって、あるべきはIPv6に移行することです。

＊

IPv6の移行が遅れているのは、改変されたIPv4が生き延びており、かつ、広がったからですが、それ以上の理由があると思っています。というのは、インターネットが広がったのは、インターネットがあるべき考え方を捨てたからではないか、ということです。そのあたりを考えるために、JPNICの「日本におけるインターネット資源管理の歴史」にはあまり詳しく書かれていなかった、ネットワークアドレス変換（Network Adress Translation）について少しだけ。

読むのはRFC1631です（https://tools.ietf.org/html/rfc1631）。RFC（Request For Comments）とはインターネットに関わるドキュメント群のことで、インターネットの標準を知るためにはこれを読むことになります。「IPネットワークアドレス変換（NAT）」という表題が付けられたRFC1631は1994年5月にポール・フランシスによって書かれました。序文に次のように書かれています。

「IPインターネットが直面している非常に切実な問題は、IPアドレスの枯渇と経路表増大である。これらの問題に対する、長期的と短期的な解決法が、開発され続けている。短期的な解決法は、CIDR（Classless Inter-Domain Routing）である。長期的な解決法は、より長いアドレスを持つ新しいインターネットプロトコルとして、さまざまな提案からなる。長期的な解決法の用意ができるまで、IPアドレスのための需要を維持するための簡単な方法は、アドレス再利用を通してである。この解決法は、あらゆる時間でドメインの外側と通信しているスタブドメイン内のホストの割合がとても少ない、という事実を利用する（スタブドメインは、ドメイン内のホストから起因されるか、またはそのホストへ向けられるトラフィックを扱うだけの企業ネットワークのようなドメインである）。確かに、（大部分でないとしても）多くのホストは、スタブドメインの外側と決して通信しない。この理由で、外側との通信が要求される時、スタブドメイン内側でのIPアドレスのサブネットのみが、世界で一意であるIPアドレスに変換される必要がある。この解決法は、IPアドレスのエンド・ツー・エンドという重要性を奪い、ネットワークに状態を作るという損失がある」

CIDRは経路制御とIPアドレスの節約を与えますが、それでもIPアドレスが足りなくなることは逃れられません。そこで、ポール・フランシスはIPアドレスの再利用を提案します。つまり、すでに割り当てられているIPアドレスを再びあるホストに割り当てるわけです。しかし、ひとつのネットワーク上に同じIPアドレスが複数あると経路が一意に定まりません。そこで、再利用IPアドレスが割り当てられたホストがアドレスが一意でいられなくなる外側と通信するときには再利用IPアドレスを世界で一意であるIPアドレスに変換するわけです。これがネットワークアドレス変換です。再利用IPアドレスはプライベートアドレス、世界で一意のIPアドレスはグローバルアドレスと呼ばれます。

ネットワークアドレス変換を行うルーターはプライベートアドレスのホストからあるホストへのリクエストを受け付けたときに、リクエストパケットの差出IPアドレスを再利用IPアドレスからグローバルアドレスに変換します。そして、どのプライベートアドレスを変換したかを記録しておき、宛先IPアドレスのホストからレスポンスを待つ状態になります。レスポンスが返ってきたら、宛先IPアドレスをプライベートアドレスに変換して、レスポンスを送り、待ち状態を解放します。「この解決法は、IPアドレスのエンド・ツー・エンドという重要性を奪い、ネットワークに状態を作るという損失がある」。「エンド・ツー・エンド」とはインターネットの考え方のひとつで、すべてのホストに送受信できる、ということです。しかし、プライベートアドレスのホストはネットワークアドレス変換によってリクエストを送りレスポンスを受けることはできても、リクエストを受けてレスポンスを返すことはできません。だから「エンド・ツー・エンドという重要性」が奪われているわけです。また、インターネットにはステートレスという考え方があります。ネットワークアドレス変換の場合はNATルーターにステートつまり状態を持たせることになります。

ポール・フランシスはネットワークアドレス変換の欠点として次のことを書いています。

「NATはホストの身元を隠す。これはプライバシーの利得を与えるが、一般的には悪い効果がある」

プライベートアドレスを割り当てられたホストはインターネット上で身元を隠すことになります。そのため、プライバシーの効果を与えるわけですね。「一般的には悪い効果がある」と言っているのは、たとえば、リクエストを受け付けることができない、ということですが、むしろ、インターネットの思想を受け入れない利用者からすれば、ほとんどの場合はよい効果を与えると言えるでしょう。

＊

というわけで、IPアドレスの管理体制について追いかけました。IPアドレスがここまで広がることを考えて作られていなかったために、インターネットはいくつかの考えを捨てているわけです。捨てるといっても、あくまで目の前を危機を乗り越えるまでの間のつもりだったわけですが、現実はそうはなりませんでした。以上のことをインターネットの技術者が書いたものから読むと、ほとんどの場合は、IPv4というのはあるべきものではないため、いつか、IPv6に移らなければならない、しかし、IPv4のCIDRやNATの技術がそれを遅らせた、というところで留まっています。しかし、CIDRやNATの技術によってインターネットの考え方が捨てられたからこそ、多くのひとに受け入れられた、というところはあると思います。たとえば、もし、ヴィント・サーフがあらかじめIPアドレスに十分な長さを与えていたら、ここまでインターネットは広がらなかったのではないか、あるいは、やはりある制限したかたちで広がったのではないか、と思います。
